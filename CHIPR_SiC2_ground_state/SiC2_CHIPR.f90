!####################################################################################
! CHIPR GROUND-STATE PES OF SiC2 IN A.U
!
! TWO-BODY AND THREE-BODY TERMS USING CHIPR 
!
! THREE-BODY TERMS CALIBRATED FROM 3682 MIXED MRCI(Q) & CCSD(T) CBS ENERGIES
! TOTAL RMSD = 3.8 kJ MOL-1
!
! R IS A 3D VECTOR OF BOND DISTANCES IN BOHR
!
! R(1) = C1-C2 BOND 
! R(2) = Si-C1 BOND
! R(3) = Si-C2 BOND
!
! POT IS THE POTENTIAL IN HARTREE
!
! SET DER=.TRUE. TO CALCULATE THE ANALYTIC GRADIENT IN INTERNAL COORDINATES
! THE DERIVATIVES ARE KEPT INTO THE 3D VECTOR DVDR    
!
!####################################################################################

      SUBROUTINE SiC2_PES(R,POT,DER,DVDR) 
      IMPLICIT NONE
      INTEGER, PARAMETER :: NX=3    
      DOUBLE PRECISION, DIMENSION(NX) :: R
      DOUBLE PRECISION :: POT
      DOUBLE PRECISION :: SUMV2,V3
      LOGICAL :: DER
      DOUBLE PRECISION, DIMENSION(NX) :: DVDR3BD
      DOUBLE PRECISION, DIMENSION(NX) :: DVDR2BD
      DOUBLE PRECISION, DIMENSION(NX) :: DVDR,V2
!######      
!###### TWO-BODY TERMS
!######         
      CALL CHIPR_C2(R(1),V2(1),DER,DVDR2BD(1))
      CALL CHIPR_SiC(R(2),V2(2),DER,DVDR2BD(2))
      CALL CHIPR_SiC(R(3),V2(3),DER,DVDR2BD(3))
!######
!###### THREE-BODY TERM
!######            
      CALL CHIPR_TRIAT(R,V3,DER,DVDR3BD)
      
      SUMV2=SUM(V2)
      POT=SUMV2+V3

!###### CALCULATING ANALYTIC DERIVATIVES OF V WITH RESPECT TO R IF DER=.TRUE.

      IF (DER) THEN
        DVDR(1)=DVDR2BD(1)+DVDR3BD(1)
        DVDR(2)=DVDR2BD(2)+DVDR3BD(2)
        DVDR(3)=DVDR2BD(3)+DVDR3BD(3)
      ELSE        
        DVDR(1)=1000
        DVDR(2)=1000
        DVDR(3)=1000
      END IF

!######

      RETURN
      END

!####################################################################################
! CALCULATES DERIVATIVES OF THE POTENTIAL WITH RESPECT TO CARTESIAN COORDINATES
! THIS USES THE CHAIN RULE
!####################################################################################

      SUBROUTINE CARTDERPES(X,V,DVDX)
      IMPLICIT NONE 
      INTEGER :: I
      INTEGER, PARAMETER :: NATOM=3     
      DOUBLE PRECISION, DIMENSION(3*NATOM) :: X
      DOUBLE PRECISION, DIMENSION(3*NATOM) :: DVDX,O
      DOUBLE PRECISION, DIMENSION(NATOM) :: Y,R,DVDR
      DOUBLE PRECISION :: V
!
!     This subprogram uses the chain rule to calculate the derivatives of the
!     energy with respect to the cartesian coordinates from the derivatives
!     with respect to the internal coordinates for a three-body system.
!     The convention assumed in this program is as follows:
!
!     R(1) = R(A-B)
!     R(2) = R(A-C)
!     R(3) = R(B-C)
!     X(1) - X(3) : X, Y, Z for atom A
!     X(4) - X(6) : X, Y, Z for atom B
!     X(7) - X(9) : X, Y, Z for atom C
!
      CALL CART2INTER(X,O,3*NATOM)

      R(1)=O(1)
      R(2)=O(2)
      R(3)=O(3)

      CALL SiC2_PES(R,V,.TRUE.,DVDR) 

      DO I=1,3
        Y(I)=DVDR(I)/R(I)
      END DO

      DVDX(1)=-Y(1)*(X(4)-X(1))-Y(2)*(X(7)-X(1)) 
      DVDX(2)=-Y(1)*(X(5)-X(2))-Y(2)*(X(8)-X(2)) 
      DVDX(3)=-Y(1)*(X(6)-X(3))-Y(2)*(X(9)-X(3)) 
      DVDX(4)= Y(1)*(X(4)-X(1))-Y(3)*(X(7)-X(4)) 
      DVDX(5)= Y(1)*(X(5)-X(2))-Y(3)*(X(8)-X(5))
      DVDX(6)= Y(1)*(X(6)-X(3))-Y(3)*(X(9)-X(6))
      DVDX(7)= Y(2)*(X(7)-X(1))+Y(3)*(X(7)-X(4))
      DVDX(8)= Y(2)*(X(8)-X(2))+Y(3)*(X(8)-X(5))
      DVDX(9)= Y(2)*(X(9)-X(3))+Y(3)*(X(9)-X(6))

      RETURN
      END

!####################################################################################
! CONVERT CARTEZIAN TO INTERPARTICLE DISTANCES (A.U)
!####################################################################################

      SUBROUTINE CART2INTER(X,R,NTA)
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER(NA=3,NT=3*NA)
      DIMENSION X(NT),R(NT)
      K=0
      DO I=1,NTA,3
       DO J=I,NTA,3
        IF(I.NE.J)THEN
         K=K+1
         R(K)=SQRT((X(I)-X(J))**2+(X(I+1)-X(J+1))**2+&
     &   (X(I+2)-X(J+2))**2)
        ENDIF
       ENDDO
      ENDDO
      RETURN
      END

!######################################################################################################

      SUBROUTINE CHIPR_TRIAT(R,POT,DER,DVDR)
      IMPLICIT NONE
      CHARACTER(LEN=3), PARAMETER :: MOLTYP="AB2"
      INTEGER, PARAMETER :: DEG=2
      INTEGER, PARAMETER :: NC=192
      INTEGER, PARAMETER :: NX=3
      INTEGER :: I,J,K,L,M,S,O,ID
      INTEGER :: POLORDER
      INTEGER, DIMENSION(DEG) :: BSORDER,NCBAS
      DOUBLE PRECISION, DIMENSION(NC) :: C
      DOUBLE PRECISION, ALLOCATABLE, DIMENSION(:) :: POL,BS
      DOUBLE PRECISION, DIMENSION(3) :: R
      DOUBLE PRECISION :: POT,REPDAMP
      INTEGER :: NCPOL,NCTOTAL,SUMC
      DOUBLE PRECISION, DIMENSION(NX) :: Y
      INTEGER :: TOTNUM,MNUM
      INTEGER, DIMENSION(3,6) :: P
      LOGICAL :: DER
      DOUBLE PRECISION, ALLOCATABLE, DIMENSION(:) :: DVDY1
      DOUBLE PRECISION, ALLOCATABLE, DIMENSION(:) :: DVDY2
      DOUBLE PRECISION, ALLOCATABLE, DIMENSION(:) :: DVDY3
      DOUBLE PRECISION, DIMENSION(NX) :: DVDR,DYDR

       C(   1)= -0.12969714563085869230008029262535274D+02
       C(   2)= -0.28981795950199731315422013722127303D+01
       C(   3)=  0.33689117237020349193699075840413570D+03
       C(   4)= -0.23923435018712023492071239161305130D+02
       C(   5)= -0.46166882945884403000036400044336915D+02
       C(   6)=  0.57756479972061377736736176302656531D+02
       C(   7)= -0.21576942099504653924668673425912857D+04
       C(   8)= -0.14138525352394160563562763854861259D+04
       C(   9)=  0.34469591498602500223569222725927830D+03
       C(  10)=  0.48230910606085245717622456140816212D+03
       C(  11)= -0.26635694929253122609225101768970490D+03
       C(  12)=  0.72588229366135146847227588295936584D+03
       C(  13)= -0.62929362929144667759828735142946243D+03
       C(  14)=  0.80786413453610648502944968640804291D+04
       C(  15)=  0.12710318890795941115356981754302979D+05
       C(  16)= -0.17474914166909477444278309121727943D+04
       C(  17)= -0.23081460549319995152472984045743942D+04
       C(  18)=  0.36477893532933040887655806727707386D+03
       C(  19)= -0.30693531416049103199839009903371334D+03
       C(  20)= -0.40944789111639156544697470963001251D+04
       C(  21)=  0.36014062240722050773911178112030029D+04
       C(  22)= -0.41478697990955952263902872800827026D+04
       C(  23)=  0.31889989863718683409388177096843719D+04
       C(  24)= -0.18031483017446604208089411258697510D+05
       C(  25)= -0.37380384451874873775523155927658081D+05
       C(  26)= -0.18428327257544420717749744653701782D+05
       C(  27)=  0.48360861661926510350895114243030548D+04
       C(  28)=  0.43880029727945302511216141283512115D+04
       C(  29)= -0.16482352960380987951793940737843513D+04
       C(  30)=  0.30311656514106844042544253170490265D+04
       C(  31)=  0.12097010805878562678117305040359497D+05
       C(  32)=  0.23419269591667275562940631061792374D+04
       C(  33)= -0.37659606452571692898345645517110825D+04
       C(  34)=  0.12903453464943906510598026216030121D+05
       C(  35)= -0.16630489188998439203714951872825623D+05
       C(  36)=  0.13908527827544259707792662084102631D+05
       C(  37)= -0.91835267681798904959578067064285278D+04
       C(  38)=  0.23239796166468946466920897364616394D+05
       C(  39)=  0.71573233010358104365877807140350342D+05
       C(  40)=  0.72448442712843127083033323287963867D+05
       C(  41)= -0.62350463998854911551461555063724518D+04
       C(  42)= -0.13539385591026334623165894299745560D+04
       C(  43)= -0.82541018348307443375233560800552368D+04
       C(  44)=  0.10851018628892214110237546265125275D+05
       C(  45)= -0.12095645061870247445767745375633240D+05
       C(  46)= -0.17679207113018990639830008149147034D+05
       C(  47)= -0.84706729216137173352763056755065918D+04
       C(  48)=  0.27188255970906789116270374506711960D+04
       C(  49)= -0.25092573695933340786723420023918152D+05
       C(  50)= -0.53069289925644543473026715219020844D+04
       C(  51)=  0.18195201704759019776247441768646240D+05
       C(  52)= -0.28993272427337851695483550429344177D+05
       C(  53)=  0.38911426889141723222564905881881714D+05
       C(  54)= -0.27410943097321945970179513096809387D+05
       C(  55)=  0.16835143877931564929895102977752686D+05
       C(  56)= -0.14667579209140585589921101927757263D+05
       C(  57)= -0.84570624761878279969096183776855469D+05
       C(  58)= -0.10582538949980704637710005044937134D+06
       C(  59)= -0.38019480841803320799954235553741455D+05
       C(  60)= -0.43004787758823289323117933236062527D+03
       C(  61)= -0.36463062981009620671102311462163925D+04
       C(  62)=  0.20165577064566288754576817154884338D+05
       C(  63)= -0.24303976003420277265831828117370605D+05
       C(  64)=  0.29071412613246979162795469164848328D+05
       C(  65)=  0.28443401713577118243847507983446121D+04
       C(  66)=  0.16155906439546592082479037344455719D+05
       C(  67)=  0.13140900266189621561352396383881569D+04
       C(  68)= -0.95073649731527220865245908498764038D+04
       C(  69)=  0.43198149901326039980631321668624878D+05
       C(  70)=  0.91675278018145454552723094820976257D+04
       C(  71)=  0.12413112939177447060501435771584511D+04
       C(  72)=  0.21011627795437707391101866960525513D+05
       C(  73)=  0.85826669906830193212954327464103699D+04
       C(  74)= -0.47241790196638583438470959663391113D+05
       C(  75)=  0.49512429865101410541683435440063477D+05
       C(  76)= -0.48139534736106354102957993745803833D+05
       C(  77)=  0.30494694893889311060775071382522583D+05
       C(  78)= -0.20909240455188381019979715347290039D+05
       C(  79)= -0.11841421741405636680610768962651491D+03
       C(  80)=  0.60549448382280723308213055133819580D+05
       C(  81)=  0.94081886036286348826251924037933350D+05
       C(  82)=  0.65042167775038869876880198717117310D+05
       C(  83)=  0.10406463813437769204028882086277008D+05
       C(  84)= -0.95062297697274334495887160301208496D+03
       C(  85)= -0.45192745588637017135624773800373077D+04
       C(  86)= -0.13990277787555571194388903677463531D+05
       C(  87)=  0.28242957087484737712657079100608826D+05
       C(  88)= -0.33405727196617182926274836063385010D+05
       C(  89)=  0.14440688823173724813386797904968262D+05
       C(  90)= -0.24536994574371019552927464246749878D+05
       C(  91)=  0.69489343473134058513096533715724945D+04
       C(  92)=  0.33014591809761491276731248944997787D+04
       C(  93)= -0.23871994804718517116270959377288818D+05
       C(  94)= -0.61713540633209740917664021253585815D+04
       C(  95)= -0.11730070880119395951624028384685516D+05
       C(  96)=  0.63879919178937971082632429897785187D+04
       C(  97)= -0.38690961617184490023646503686904907D+05
       C(  98)= -0.21026054965186017398082185536623001D+04
       C(  99)=  0.11458147162152363307541236281394958D+04
       C( 100)= -0.89685016495776490046409890055656433D+04
       C( 101)= -0.80834243341020473962998948991298676D+04
       C( 102)=  0.59828170749486955173779278993606567D+05
       C( 103)= -0.54756941126497164077591150999069214D+05
       C( 104)=  0.30788968728505940816830843687057495D+05
       C( 105)= -0.17108562851355993188917636871337891D+05
       C( 106)=  0.17343277299841443891637027263641357D+05
       C( 107)=  0.59451247760415817538159899413585663D+04
       C( 108)= -0.27920541175697300786850973963737488D+05
       C( 109)= -0.31795518850800188374705612659454346D+05
       C( 110)= -0.62709413879285944858565926551818848D+05
       C( 111)=  0.43006918230203345956397242844104767D+04
       C( 112)= -0.10537950815796593815321102738380432D+05
       C( 113)=  0.76329889263091363318380899727344513D+04
       C( 114)= -0.17439478474173622089438140392303467D+05
       C( 115)=  0.35064260200356409768573939800262451D+05
       C( 116)= -0.29782156540001389657845720648765564D+05
       C( 117)=  0.15604888509798227460123598575592041D+05
       C( 118)= -0.58001115902431465656263753771781921D+04
       C( 119)=  0.12257799432721796620171517133712769D+05
       C( 120)= -0.22064493181190227915067225694656372D+05
       C( 121)=  0.13307580687962907177279703319072723D+05
       C( 122)=  0.10593331633799038172583095729351044D+05
       C( 123)= -0.15557253070290678806486539542675018D+05
       C( 124)=  0.37097076997983822366222739219665527D+05
       C( 125)= -0.87254182997749994683545082807540894D+04
       C( 126)= -0.15451105462207991877221502363681793D+05
       C( 127)=  0.32235464924631574831437319517135620D+05
       C( 128)= -0.27105771659398917108774185180664062D+05
       C( 129)=  0.18323756376054032443789765238761902D+05
       C( 130)=  0.98551544249712042073952034115791321D+04
       C( 131)=  0.91188362172716151690110564231872559D+04
       C( 132)=  0.76910730956548468384426087141036987D+04
       C( 133)= -0.11835134228113445715280249714851379D+05
       C( 134)=  0.59904424204774159079534001648426056D+04
       C( 135)= -0.11725341832495819289761129766702652D+04
       C( 136)= -0.34269624932541766611393541097640991D+05
       C( 137)=  0.34475880019666139560285955667495728D+05
       C( 138)= -0.90789072715746551693882793188095093D+04
       C( 139)=  0.27753079126397610707499552518129349D+04
       C( 140)= -0.85190814253951321006752550601959229D+04
       C( 141)= -0.26489236009005030609841924160718918D+04
       C( 142)=  0.76678326947115647271857596933841705D+04
       C( 143)= -0.16619082229652576643275097012519836D+04
       C( 144)=  0.23888817912456150224898010492324829D+05
       C( 145)= -0.25070127699477493479207623749971390D+04
       C( 146)=  0.34360449328511172097933012992143631D+04
       C( 147)= -0.42742196362735585353220812976360321D+04
       C( 148)=  0.94880049991026462521404027938842773D+04
       C( 149)= -0.10341122375799401197582483291625977D+05
       C( 150)= -0.17724873209874110671080416068434715D+04
       C( 151)=  0.81411535291338213937706314027309418D+04
       C( 152)= -0.19349410583168394168751547113060951D+04
       C( 153)= -0.95255479949448738352657528594136238D+03
       C( 154)=  0.22892112783139041312097106128931046D+04
       C( 155)= -0.45375331329889149856171570718288422D+04
       C( 156)=  0.24036310008982100043795071542263031D+04
       C( 157)= -0.59059905281999281214666552841663361D+04
       C( 158)=  0.54024971824127387662883847951889038D+04
       C( 159)= -0.12865437550008682592306286096572876D+05
       C( 160)=  0.29490610425487644533859565854072571D+05
       C( 161)= -0.19822743955630605341866612434387207D+05
       C( 162)=  0.51832528408128682713140733540058136D+04
       C( 163)=  0.58979776427868737300741486251354218D+04
       C( 164)= -0.24201887838140512030804529786109924D+05
       C( 165)=  0.91824901725568834081059321761131287D+04
       C( 166)= -0.25703312300327829689194913953542709D+04
       C( 167)= -0.11757601102590653681545518338680267D+05
       C( 168)=  0.27692185001015226589515805244445801D+05
       C( 169)= -0.14959046422159330177237279713153839D+05
       C( 170)=  0.32467898054510385463800048455595970D+03
       C( 171)= -0.10386109413093445255071856081485748D+04
       C( 172)= -0.62301352186316662482568062841892242D+04
       C( 173)=  0.39483089964708160550799220800399780D+04
       C( 174)= -0.18404918004830667541682487353682518D+04
       C( 175)=  0.33546265883954529272159561514854431D+04
       C( 176)=  0.79146865221214466146193444728851318D+04
       C( 177)= -0.98159179377882574044633656740188599D+04
       C( 178)=  0.69825496972700545939005678519606590D+03
       C( 179)=  0.86587998252548516120441490784287453D+03
       C( 180)=  0.18247095123875749322905903682112694D+04
       C( 181)=  0.27553563654330703869277385820169002D+00
       C( 182)=  0.14692623981305912820971570909023285D+05
       C( 183)=  0.75000000000000000000000000000000000D+00
       C( 184)=  0.50000000000000000000000000000000000D+00
       C( 185)=  0.15500000000000000444089209850062616D+01
       C( 186)=  0.50000000000000000000000000000000000D+00
       C( 187)=  0.32320184402610707685710167424986139D+00
       C( 188)=  0.14418523204558876386727206408977509D+05
       C( 189)=  0.75000000000000000000000000000000000D+00
       C( 190)=  0.50000000000000000000000000000000000D+00
       C( 191)=  0.35000000000000000000000000000000000D+01
       C( 192)=  0.75000000000000000000000000000000000D+00
      
      BSORDER(1)=2
      BSORDER(2)=2

      POLORDER=11

      DO I=1,DEG
        NCBAS(I)=0
        NCBAS(I)=2*BSORDER(I)+2
      END DO

      CALL POLNC(POLORDER,MOLTYP,NCPOL)

      IF (NC.NE.(NCPOL+SUM(NCBAS))) THEN 
        WRITE(*,*) "PROBLEMS IN DEFINING PROPER NUMBER OF COEFFICIENTS"
        WRITE(*,*) "TOTAL NUMBER OF COEFFS ARE NOT SUMMING UP CORRECTLY"
        STOP
      END IF

      ALLOCATE(POL(NCPOL))
      ALLOCATE(DVDY1(NCPOL),DVDY2(NCPOL),DVDY3(NCPOL))

      DO I=1,NCPOL
        POL(I)=0.00D+00
        DVDY1(I)=0.00D+00
        DVDY2(I)=0.00D+00
        DVDY3(I)=0.00D+00
      END DO

      DO I=1,NX
        Y(I)=0.0D+00
        DYDR(I)=0.0D+00
        DVDR(I)=0.0D+00
      END DO

      SUMC=NCPOL
      DO I=1,DEG
        ALLOCATE(BS(NCBAS(I)))
        DO J=1,NCBAS(I)
          BS(J)=0.0D+00
        END DO
        K=SUMC
        DO J=1,NCBAS(I)
          K=K+1
          BS(J)=C(K)
        END DO

!######
! AB2-TYPE
!######
        IF (DEG.EQ.2) THEN
          IF (I.EQ.1) THEN
!
!           B-B BASIS
!
            CALL BASIS_CONTRACT(1,BSORDER(1),BS,R(1),Y(1))

!###### CALCULATING ANALYTIC DERIVATIVES OF Y WITH RESPECT TO R IF DER=.TRUE.
            
            IF (DER) THEN
              CALL DBASIS_CONTRACT(1,BSORDER(1),BS,R(1),DYDR(1))
            END IF

!###### 
          ELSE
!
!           A-B BASIS
!
            DO O=2,3 
              CALL BASIS_CONTRACT(2,BSORDER(2),BS,R(O),Y(O))

!###### CALCULATING ANALYTIC DERIVATIVES OF Y WITH RESPECT TO R IF DER=.TRUE.
            
              IF (DER) THEN
                CALL DBASIS_CONTRACT(2,BSORDER(2),BS,R(O),DYDR(O))
              END IF

!######
            END DO
          END IF            
        END IF

        SUMC=SUMC+NCBAS(I)
        DEALLOCATE(BS)
      END DO

      TOTNUM=0
      S=0
      DO M=0,POLORDER
        MNUM=0
        DO I=0,M
          DO J=0,(M-I)
            K=M-I-J
            S=I+J+K
            IF (S.NE.I .AND. S.NE.J .AND. S.NE.K) THEN

              IF (MOLTYP.EQ."ABC") THEN  

                TOTNUM=TOTNUM+1
                MNUM=MNUM+1

                CALL PERMUTABC(I,J,K,P,ID)

                DO L=1,ID

                  POL(TOTNUM)=POL(TOTNUM)+&
     &               (Y(1)**(P(1,L))*Y(2)**(P(2,L))*Y(3)**(P(3,L)))

!###### CALCULATING ANALYTIC DERIVATIVES OF V WITH RESPECT TO Y IF DER=.TRUE.

                      IF (DER) THEN
             
                        DVDY1(TOTNUM)=DVDY1(TOTNUM)+&
     &                 (DBLE(P(1,L))*Y(1)**(P(1,L)-1)*Y(2)**(P(2,L))*Y(3)**(P(3,L))) 

                        DVDY2(TOTNUM)=DVDY2(TOTNUM)+&
     &                 (Y(1)**(P(1,L))*DBLE(P(2,L))*Y(2)**(P(2,L)-1)*Y(3)**(P(3,L)))    

                        DVDY3(TOTNUM)=DVDY3(TOTNUM)+&
     &                 (Y(1)**(P(1,L))*Y(2)**(P(2,L))*DBLE(P(3,L))*Y(3)**(P(3,L)-1)) 
             
                      END IF

!######
                END DO

                POL(TOTNUM)=C(TOTNUM)*POL(TOTNUM)/DBLE(ID)

!###### MULTIPLYING THE CONTRIBUTIONS OF DVDY BY THE POLYNOMIAL COEFFS. IF DER=.TRUE.

                IF (DER) THEN
                  DVDY1(TOTNUM)=C(TOTNUM)*DVDY1(TOTNUM)/DBLE(ID)
                  DVDY2(TOTNUM)=C(TOTNUM)*DVDY2(TOTNUM)/DBLE(ID)
                  DVDY3(TOTNUM)=C(TOTNUM)*DVDY3(TOTNUM)/DBLE(ID)
                END IF

!######
              ELSE IF (MOLTYP.EQ."AB2") THEN 

                IF (J.LE.K) THEN 

                  TOTNUM=TOTNUM+1
                  MNUM=MNUM+1

                  CALL PERMUTAB2(I,J,K,P,ID)
                   
                  DO L=1,ID

                    POL(TOTNUM)=POL(TOTNUM)+&
     &                 (Y(1)**(P(1,L))*Y(2)**(P(2,L))*Y(3)**(P(3,L)))

!###### CALCULATING ANALYTIC DERIVATIVES OF V WITH RESPECT TO Y IF DER=.TRUE.

                      IF (DER) THEN
             
                        DVDY1(TOTNUM)=DVDY1(TOTNUM)+&
     &                 (DBLE(P(1,L))*Y(1)**(P(1,L)-1)*Y(2)**(P(2,L))*Y(3)**(P(3,L))) 

                        DVDY2(TOTNUM)=DVDY2(TOTNUM)+&
     &                 (Y(1)**(P(1,L))*DBLE(P(2,L))*Y(2)**(P(2,L)-1)*Y(3)**(P(3,L)))    

                        DVDY3(TOTNUM)=DVDY3(TOTNUM)+&
     &                 (Y(1)**(P(1,L))*Y(2)**(P(2,L))*DBLE(P(3,L))*Y(3)**(P(3,L)-1)) 
             
                      END IF

!######
                  END DO

                  POL(TOTNUM)=C(TOTNUM)*POL(TOTNUM)/DBLE(ID)

!###### MULTIPLYING THE CONTRIBUTIONS OF DVDY BY THE POLYNOMIAL COEFFS. IF DER=.TRUE.

                  IF (DER) THEN
                    DVDY1(TOTNUM)=C(TOTNUM)*DVDY1(TOTNUM)/DBLE(ID)
                    DVDY2(TOTNUM)=C(TOTNUM)*DVDY2(TOTNUM)/DBLE(ID)
                    DVDY3(TOTNUM)=C(TOTNUM)*DVDY3(TOTNUM)/DBLE(ID)
                  END IF

!######
                END IF    
         
              ELSE IF (MOLTYP.EQ."A3") THEN

                IF (I.LE.J .AND. J.LE.K) THEN

                  TOTNUM=TOTNUM+1
                  MNUM=MNUM+1

                  CALL PERMUTA3(I,J,K,P,ID)
                   
                  DO L=1,ID

                    POL(TOTNUM)=POL(TOTNUM)+&
     &                 (Y(1)**(P(1,L))*Y(2)**(P(2,L))*Y(3)**(P(3,L)))

!###### CALCULATING ANALYTIC DERIVATIVES OF V WITH RESPECT TO Y IF DER=.TRUE.

                      IF (DER) THEN
             
                        DVDY1(TOTNUM)=DVDY1(TOTNUM)+&
     &                 (DBLE(P(1,L))*Y(1)**(P(1,L)-1)*Y(2)**(P(2,L))*Y(3)**(P(3,L))) 

                        DVDY2(TOTNUM)=DVDY2(TOTNUM)+&
     &                 (Y(1)**(P(1,L))*DBLE(P(2,L))*Y(2)**(P(2,L)-1)*Y(3)**(P(3,L)))    

                        DVDY3(TOTNUM)=DVDY3(TOTNUM)+&
     &                 (Y(1)**(P(1,L))*Y(2)**(P(2,L))*DBLE(P(3,L))*Y(3)**(P(3,L)-1)) 
             
                      END IF

!######
                  END DO

                  POL(TOTNUM)=C(TOTNUM)*POL(TOTNUM)/DBLE(ID)

!###### MULTIPLYING THE CONTRIBUTIONS OF DVDY BY THE POLYNOMIAL COEFFS. IF DER=.TRUE.

                  IF (DER) THEN
                    DVDY1(TOTNUM)=C(TOTNUM)*DVDY1(TOTNUM)/DBLE(ID)
                    DVDY2(TOTNUM)=C(TOTNUM)*DVDY2(TOTNUM)/DBLE(ID)
                    DVDY3(TOTNUM)=C(TOTNUM)*DVDY3(TOTNUM)/DBLE(ID)
                  END IF

!######
                END IF

              END IF

            END IF
          END DO
        END DO

      END DO

      POT=SUM(POL)*REPDAMP(NX,R)

!###### CALCULATING ANALYTIC DERIVATIVES OF V WITH RESPECT TO R IF DER=.TRUE.

      IF (DER) THEN
        DVDR(1)=SUM(DVDY1)*DYDR(1)
        DVDR(2)=SUM(DVDY2)*DYDR(2)
        DVDR(3)=SUM(DVDY3)*DYDR(3)
      ELSE 
        DVDR(1)=1000
        DVDR(2)=1000
        DVDR(3)=1000
      END IF

!######

      DEALLOCATE(POL)
      DEALLOCATE(DVDY1,DVDY2,DVDY3)

      RETURN
      END
      
!################################################################################
! DAMPING THE 3-BODY ENERGY TERM AT SHORT INTERNUCLEAR DISTANCES
!################################################################################ 

      DOUBLE PRECISION FUNCTION REPDAMP(NX,R)
      IMPLICIT NONE
      INTEGER :: I,NX
      DOUBLE PRECISION, DIMENSION(NX) :: R,H
      DOUBLE PRECISION :: KAPPA, XI, R0
      R0=0.5D+00
      KAPPA=100.0D+00
      XI=10.0D+00
      DO I=1,NX
        H(I)=(0.5D+00*(1.00D+00+TANH(KAPPA*(R(I)-R0))))
      END DO
      REPDAMP=(PRODUCT(H))**(XI)      
      END FUNCTION      

!######################################################################################################

      SUBROUTINE CHIPR_SiC(R,POT,DER,DVDR)
      IMPLICIT NONE
      INTEGER, PARAMETER :: NC=24
      INTEGER :: I,J
      INTEGER :: BSORDER
      INTEGER :: POLORDER
      INTEGER :: NCBAS,NCPOL
      DOUBLE PRECISION, DIMENSION(2) :: Z
      DOUBLE PRECISION, DIMENSION(NC) :: C
      DOUBLE PRECISION, ALLOCATABLE, DIMENSION(:) :: BS
      DOUBLE PRECISION :: Y   
      DOUBLE PRECISION :: R,POT
      LOGICAL :: DER
      DOUBLE PRECISION :: DYDR
      DOUBLE PRECISION :: DVDRPART1
      DOUBLE PRECISION :: DVDRPART2
      DOUBLE PRECISION :: DVDR

      Z(  1)=  0.60000000000000000000000000000000000D+01
      Z(  2)=  0.14000000000000000000000000000000000D+02

      C(  1)=  0.74748573762006467052776415016523970D-02
      C(  2)=  0.13896486594960813509835872991970973D+00
      C(  3)=  0.44031454894917558817724057007580996D+01
      C(  4)= -0.13888389959650467062601819634437561D+04
      C(  5)= -0.39173482714575526188127696514129639D+05
      C(  6)= -0.43432062720686977263540029525756836D+06
      C(  7)= -0.21963770319024808704853057861328125D+07
      C(  8)= -0.49699009718037340790033340454101562D+07
      C(  9)= -0.17303256821271706372499465942382812D+08
      C( 10)= -0.10317362706312467157840728759765625D+09
      C( 11)= -0.20444473089682644605636596679687500D+09
      C( 12)= -0.25330130046192488074302673339843750D+09
      C( 13)=  0.95823067790508639812469482421875000D+09
      C( 14)=  0.11930971123467397689819335937500000D+11
      C( 15)= -0.12401090338018053160773490617430070D+00
      C( 16)=  0.12915091364993452199838586125224538D-01
      C( 17)=  0.37487079955892822769047967312872061D-01
      C( 18)= -0.17897493475958460749097866937518120D+04
      C( 19)=  0.46295762003455565025689111280371435D+00
      C( 20)=  0.13113020004292406106571888813050464D+01
      C( 21)=  0.84564735156863768406054759907419793D+00
      C( 22)=  0.42514362518898690668223139255132992D+00
      C( 23)=  0.12998712639233773735725208098301664D+01
      C( 24)=  0.15795636862866988536779899732209742D+01

      BSORDER=4

      POLORDER=14

      NCBAS=2*BSORDER+2

      NCPOL=POLORDER

      ALLOCATE(BS(NCBAS))

      DO I=1,NCBAS
        BS(I)=0.00D+00
      END DO

      DO I=1,NCBAS
        J=NCPOL+I
        BS(I)=C(J)
      END DO
 
      Y=0.00D+00
      POT=0.00D+00

      CALL BASIS_CONTRACT(1,BSORDER,BS,R,Y)

      DO I=1,POLORDER
        POT=POT+(Z(1)*Z(2)/R)*C(I)*Y**(DBLE(I))
      END DO

!###### CALCULATING ANALYTIC DERIVATIVES IF DER=.TRUE.

      IF (DER) THEN 
        CALL DBASIS_CONTRACT(1,BSORDER,BS,R,DYDR)
        DVDRPART1=-POT/R
        DVDRPART2=0.00D+00
        DO I=1,POLORDER
          DVDRPART2=DVDRPART2+(Z(1)*Z(2)/R)*C(I)*DBLE(I)*Y**(DBLE(I-1))
        END DO
        DVDRPART2=DVDRPART2*DYDR
        DVDR=DVDRPART1+DVDRPART2
      ELSE
        DVDR=1000
      ENDIF

!######

      DEALLOCATE(BS)

      RETURN
      END
         
!######################################################################################################

      SUBROUTINE CHIPR_C2(R,POT,DER,DVDR)
      IMPLICIT NONE
      INTEGER, PARAMETER :: NC=22
      INTEGER :: I,J
      INTEGER :: BSORDER
      INTEGER :: POLORDER
      INTEGER :: NCBAS,NCPOL
      DOUBLE PRECISION, DIMENSION(2) :: Z
      DOUBLE PRECISION, DIMENSION(NC) :: C
      DOUBLE PRECISION, ALLOCATABLE, DIMENSION(:) :: BS
      DOUBLE PRECISION :: Y   
      DOUBLE PRECISION :: R,POT
      LOGICAL :: DER
      DOUBLE PRECISION :: DYDR
      DOUBLE PRECISION :: DVDRPART1
      DOUBLE PRECISION :: DVDRPART2
      DOUBLE PRECISION :: DVDR

      Z(  1)=  0.60000000000000000000000000000000000D+01
      Z(  2)=  0.60000000000000000000000000000000000D+01

      C(  1)=  0.25400653490294206743316252072872885D-01
      C(  2)=  0.29205851999229807958169402581916074D-01
      C(  3)=  0.28585799210269775827431004699974437D-01
      C(  4)=  0.67709595572945802804953885356553656D-02
      C(  5)= -0.30171664669936672925620868568330479D-01
      C(  6)= -0.31193025388905736700051463117233652D-01
      C(  7)=  0.70567454605977492088086933108570520D-01
      C(  8)=  0.19492105542621596114827298151794821D+00
      C(  9)=  0.17268454528472909625946840606047772D+00
      C( 10)=  0.46786282573429871511905275838216767D-01
      C( 11)= -0.15662574345293944766410731972428039D-01
      C( 12)= -0.82749902555507275775381614835168875D-02
      C( 13)= -0.16136303779771361474604240981989278D-02
      C( 14)= -0.43664393003147911054284691090288106D+00
      C( 15)= -0.32332760335351227176658994721947238D+01
      C( 16)=  0.61344284466357297787908464670181274D+05
      C( 17)=  0.11859219475394039422511127668258268D+00
      C( 18)=  0.34535683308796008006424926861654967D+01
      C( 19)=  0.10842372088218057424313656156300567D+01
      C( 20)=  0.57107351824085317293366870217141695D+00
      C( 21)=  0.11869360172429590516429698254796676D+01
      C( 22)=  0.19410370886066858897578413234441541D+01

      BSORDER=4

      POLORDER=12

      NCBAS=2*BSORDER+2

      NCPOL=POLORDER

      ALLOCATE(BS(NCBAS))

      DO I=1,NCBAS
        BS(I)=0.00D+00
      END DO

      DO I=1,NCBAS
        J=NCPOL+I
        BS(I)=C(J)
      END DO
 
      Y=0.00D+00
      POT=0.00D+00

      CALL BASIS_CONTRACT(1,BSORDER,BS,R,Y)

      DO I=1,POLORDER
        POT=POT+(Z(1)*Z(2)/R)*C(I)*Y**(DBLE(I))
      END DO

!###### CALCULATING ANALYTIC DERIVATIVES IF DER=.TRUE.

      IF (DER) THEN 
        CALL DBASIS_CONTRACT(1,BSORDER,BS,R,DYDR)
        DVDRPART1=-POT/R
        DVDRPART2=0.00D+00
        DO I=1,POLORDER
          DVDRPART2=DVDRPART2+(Z(1)*Z(2)/R)*C(I)*DBLE(I)*Y**(DBLE(I-1))
        END DO
        DVDRPART2=DVDRPART2*DYDR
        DVDR=DVDRPART1+DVDRPART2
      ELSE
        DVDR=1000
      ENDIF

!######

      DEALLOCATE(BS)

      RETURN
      END
      
!################################################################################      
      
      SUBROUTINE PERMUTABC(I,J,K,P,ID)
      IMPLICIT NONE
      INTEGER :: I,J,K
      INTEGER :: L,M,ID
      INTEGER, DIMENSION(3) :: INTER
      INTEGER, DIMENSION(3,6) :: P

      DO L=1,3 
        DO M=1,6
          P(L,M)=0
        END DO
      END DO

      INTER(1)=I
      INTER(2)=J
      INTER(3)=K

      ID=1

      P(1,1)=INTER(1)
      P(2,1)=INTER(2)
      P(3,1)=INTER(3) 

      RETURN
      END

!################################################################################      
      
      SUBROUTINE PERMUTAB2(I,J,K,P,ID)
      IMPLICIT NONE
      INTEGER :: I,J,K
      INTEGER :: L,M,ID
      INTEGER, DIMENSION(3) :: INTER
      INTEGER, DIMENSION(3,6) :: P

      DO L=1,3 
        DO M=1,6
          P(L,M)=0
        END DO
      END DO
      
      INTER(1)=I
      INTER(2)=J
      INTER(3)=K
      
      IF (J.NE.K) THEN  
 
        ID=2

        P(1,1)=INTER(1)
        P(2,1)=INTER(2)
        P(3,1)=INTER(3)      

        P(1,2)=INTER(1)
        P(2,2)=INTER(3)
        P(3,2)=INTER(2) 

       ELSE 

        ID=1

        P(1,1)=INTER(1)
        P(2,1)=INTER(2)
        P(3,1)=INTER(3)

       END IF

      RETURN 
      END 

!################################################################################      
      
      SUBROUTINE PERMUTA3(I,J,K,P,ID)
      IMPLICIT NONE
      INTEGER :: I,J,K
      INTEGER :: L,M,ID
      INTEGER, DIMENSION(3) :: INTER
      INTEGER, DIMENSION(3,6) :: P

      DO L=1,3 
        DO M=1,6
          P(L,M)=0
        END DO
      END DO
      
      INTER(1)=I
      INTER(2)=J
      INTER(3)=K
      
      IF (I.EQ.J.AND.J.EQ.K.AND.I.EQ.K) THEN
      
        ID=1

        P(1,1)=INTER(1)
        P(2,1)=INTER(2)
        P(3,1)=INTER(3)  
        
      ELSE IF (I.NE.J.AND.J.NE.K.AND.I.NE.K) THEN   

        ID=6

        P(1,1)=INTER(1)
        P(2,1)=INTER(2)
        P(3,1)=INTER(3)      

        P(1,2)=INTER(2)
        P(2,2)=INTER(1)
        P(3,2)=INTER(3)  

        P(1,3)=INTER(3)
        P(2,3)=INTER(2)
        P(3,3)=INTER(1) 

        P(1,4)=INTER(1)
        P(2,4)=INTER(3)
        P(3,4)=INTER(2) 

        P(1,5)=P(1,2)
        P(2,5)=P(3,2)
        P(3,5)=P(2,2)  

        P(1,6)=P(1,3)
        P(2,6)=P(3,3)
        P(3,6)=P(2,3)  
        
      ELSE IF (I.EQ.J) THEN       
     
        ID=3     

        P(1,1)=INTER(1)
        P(2,1)=INTER(2)
        P(3,1)=INTER(3) 

        P(1,2)=INTER(3)
        P(2,2)=INTER(2)
        P(3,2)=INTER(1) 

        P(1,3)=INTER(1)
        P(2,3)=INTER(3)
        P(3,3)=INTER(2)
        
      ELSE IF (J.EQ.K) THEN       
                    
        ID=3     

        P(1,1)=INTER(1)
        P(2,1)=INTER(2)
        P(3,1)=INTER(3)      

        P(1,2)=INTER(2)
        P(2,2)=INTER(1)
        P(3,2)=INTER(3)  

        P(1,3)=INTER(3)
        P(2,3)=INTER(2)
        P(3,3)=INTER(1) 
        
      ELSE IF (I.EQ.K) THEN    
  
        ID=3  

        P(1,1)=INTER(1)
        P(2,1)=INTER(2)
        P(3,1)=INTER(3)      

        P(1,2)=INTER(2)
        P(2,2)=INTER(1)
        P(3,2)=INTER(3)  

        P(1,3)=INTER(1)
        P(2,3)=INTER(3)
        P(3,3)=INTER(2)        
    
      END IF

      RETURN 
      END 

!################################################################################ 

      SUBROUTINE POLNC(ORDER,MOLTYP,NC)
      IMPLICIT NONE
      INTEGER :: I,J,K,L,M,S
      INTEGER :: NC,MNUM,ORDER
      CHARACTER(LEN=3) :: MOLTYP

      NC=0
      S=0

      DO M=0,ORDER
        MNUM=0
        DO I=0,M
          DO J=0,(M-I)
            K=M-I-J
            S=I+J+K
            IF (S.NE.I .AND. S.NE.J .AND. S.NE.K) THEN
 
              IF (MOLTYP.EQ."ABC") THEN  

                NC=NC+1
                MNUM=MNUM+1

              ELSE IF (MOLTYP.EQ."AB2") THEN 

                IF (J.LE.K) THEN 

                  NC=NC+1
                  MNUM=MNUM+1

                END IF    
        
              ELSE IF (MOLTYP.EQ."A3") THEN

                IF (I.LE.J .AND. J.LE.K) THEN

                  NC=NC+1
                  MNUM=MNUM+1

                END IF

              END IF

            END IF
          END DO
        END DO
      END DO

      RETURN
      END      

!######################################################################################################

      SUBROUTINE BASIS_CONTRACT(DEG,M,C,R,YVAL)
      IMPLICIT NONE
      INTEGER :: I,J,DEG
      INTEGER :: M
      DOUBLE PRECISION :: RREF0,ZETA
      DOUBLE PRECISION, DIMENSION(2*M+2) :: C
      DOUBLE PRECISION, DIMENSION(M) :: GAMA,VAL
      DOUBLE PRECISION :: R,YVAL

      DO I=1,M
        GAMA(I)=C(M+I)
      END DO

      RREF0=C(2*M+1)
      ZETA=C(2*M+2)

      DO I=1,M-1
        CALL PHISECBASIS(DEG,I,RREF0,ZETA,GAMA(I),1,R,VAL(I))
      END DO

      DO I=M,M
        CALL PHICSECBASIS(DEG,I,RREF0,ZETA,GAMA(I),1,6,R,VAL(I))
      END DO

      YVAL=0.00D+00

      DO J=1,M
        YVAL=YVAL+C(J)*VAL(J)
      END DO

      RETURN
      END

!######################################################################################################

      SUBROUTINE PHISECBASIS(DEG,IND,RREF0,ZETA,GAMA,ETA,R,VAL)
      IMPLICIT NONE
      INTEGER :: DEG, IND, ETA
      DOUBLE PRECISION :: RREF0, ZETA, RREFIND 
      DOUBLE PRECISION :: GAMA, R, VAL, RHO
      DOUBLE PRECISION :: SECH, ORIG
      RREFIND=ORIG(IND,ZETA,RREF0)
      RHO=(R-RREFIND)
      VAL=(SECH(GAMA*RHO))**(DBLE(ETA))
      RETURN
      END

!######################################################################################################

      SUBROUTINE PHICSECBASIS(DEG,IND,RREF0,ZETA,GAMA,ETA,LR,R,VAL)
      IMPLICIT NONE
      INTEGER :: DEG, IND, LR, ETA
      DOUBLE PRECISION :: RREF0, ZETA, RREFIND 
      DOUBLE PRECISION :: GAMA, R, VAL, RHO
      DOUBLE PRECISION :: SECH, BETA, FAC, ORIG
      BETA=1.00D+00/5.0D+00
      RREFIND=ORIG(IND,ZETA,RREF0)
      RHO=(R-RREFIND)
      FAC=(TANH(BETA*R)/R)**(DBLE(LR))
      VAL=FAC*(SECH(GAMA*RHO))**(DBLE(ETA))
      RETURN
      END

!######################################################################################################

      SUBROUTINE DBASIS_CONTRACT(DEG,M,C,R,DYDR)
      IMPLICIT NONE
      INTEGER :: I,J,DEG
      INTEGER :: M
      DOUBLE PRECISION :: RREF0,ZETA
      DOUBLE PRECISION, DIMENSION(2*M+2) :: C
      DOUBLE PRECISION, DIMENSION(M) :: GAMA,DPHIDR
      DOUBLE PRECISION :: R,DYDR

      DO I=1,M
        GAMA(I)=C(M+I)
      END DO

      RREF0=C(2*M+1)
      ZETA=C(2*M+2)

      DO I=1,M-1
        CALL DPHISECBASIS(DEG,I,RREF0,ZETA,GAMA(I),1,R,DPHIDR(I))
      END DO

      DO I=M,M
        CALL DPHICSECBASIS(DEG,I,RREF0,ZETA,GAMA(I),1,6,R,DPHIDR(I))
      END DO

      DYDR=0.00D+00

      DO J=1,M
        DYDR=DYDR+C(J)*DPHIDR(J)
      END DO

      RETURN
      END

!######################################################################################################

      SUBROUTINE DPHISECBASIS(DEG,IND,RREF0,ZETA,GAMA,ETA,R,DPHIDR)
      IMPLICIT NONE
      INTEGER :: DEG, IND, ETA
      DOUBLE PRECISION :: RREF0, ZETA, RREFIND 
      DOUBLE PRECISION :: GAMA, R, VAL, RHO
      DOUBLE PRECISION :: SECH, ORIG
      DOUBLE PRECISION :: PART1,PART2
      DOUBLE PRECISION :: DPHIDR
      RREFIND=ORIG(IND,ZETA,RREF0)
      RHO=(R-RREFIND)
      PART1=(SECH(GAMA*RHO))**(DBLE(ETA))
      PART2=(TANH(GAMA*RHO))
      DPHIDR=-(DBLE(ETA))*GAMA*PART1*PART2
      RETURN
      END

!######################################################################################################

      SUBROUTINE DPHICSECBASIS(DEG,IND,RREF0,ZETA,GAMA,ETA,LR,R,DPHIDR)
      IMPLICIT NONE
      INTEGER :: DEG, IND, LR, ETA
      DOUBLE PRECISION :: RREF0, ZETA, RREFIND 
      DOUBLE PRECISION :: GAMA, R, VAL, RHO
      DOUBLE PRECISION :: SECH, BETA, FAC, ORIG
      DOUBLE PRECISION :: FAC1PART1,FAC2PART1
      DOUBLE PRECISION :: FAC3PART1,FAC1PART2
      DOUBLE PRECISION :: FAC2PART2,FAC3PART2
      DOUBLE PRECISION :: PART1,PART2
      DOUBLE PRECISION :: DPHIDR
      BETA=1.00D+00/5.0D+00
      RREFIND=ORIG(IND,ZETA,RREF0)
      RHO=(R-RREFIND)
      FAC1PART1=(TANH(BETA*R)/R)**(DBLE(LR-1))
      FAC2PART1=(BETA*(SECH(BETA*R))**(2)/R)-(TANH(BETA*R)/R**2)
      FAC3PART1=(SECH(GAMA*RHO))**(DBLE(ETA))
      PART1=(DBLE(LR))*FAC1PART1*FAC2PART1*FAC3PART1
      FAC1PART2=(SECH(GAMA*RHO))**(DBLE(ETA))
      FAC2PART2=(TANH(GAMA*RHO))
      FAC3PART2=(TANH(BETA*R)/R)**(DBLE(LR))
      PART2=-(DBLE(ETA))*GAMA*FAC1PART2*FAC2PART2*FAC3PART2
      DPHIDR=PART1+PART2
      RETURN
      END

!######################################################################################################

      DOUBLE PRECISION FUNCTION ORIG(IND,ZETA,RREF0)
      IMPLICIT NONE
      INTEGER :: IND
      DOUBLE PRECISION :: ZETA,RREF0
      ORIG=ZETA*(RREF0)**(DBLE(IND)-1.0D+00)
      RETURN
      END

!######################################################################################################

      DOUBLE PRECISION FUNCTION SECH(X)
      IMPLICIT NONE
      DOUBLE PRECISION :: X
      SECH=1.00D+00/(COSH(X))      
      RETURN
      END      

